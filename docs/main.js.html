<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: main.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: main.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file main.js
 * @author Smittel
 * @name Server
 * @description I really dont feel like documenting this rn, any questions hmu
 */

const express = require('express');
const app = express();
const http = require('http');
const server = http.createServer(app);
const { Server } = require("socket.io");
const io = new Server(server);
const fs = require("fs")
app.use(express.static('public'));

let notes = {
	"test": [{"d": 0, "t": "testoman"},{"d": 10000, "t":"another"}]
}

//PASSWORDS ARE TEMPORARY AND TO BE REPLACED WITH AN ENCRYPTED VERSION
// WHOLE THING NEEDS REWORKING
// A DATABASE SHOULD DO THE TRICK

let friends = {
	
}

const desktopSymbols = {
		symbols: [
		{
			pos: ["calc(50% - 10vmin)","calc(50% - 10vmin"],
			image: "folder-blender.png",
			type: "folder",
			name: "Blender",
			data: null, // null for folders
			sub: [
				{
					image: "",
					name: "text",
					type: "internal",
					data: "request"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				}
			]
		},{
			pos: ["calc(50% - 15vmin)","calc(50% - 60vmin"],
			image: "github-logo.png",
			type: "folder",
			name: "Test",
			data: null,
			sub: [
				{
					image: "",
					name: "text",
					type: "internal",
					data: "request"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				},{
					image: "",
					name: "text",
					type: "external",
					data: "link"
				}
			]
		},{
			pos: ["calc(50% - 15vmin)","calc(50% - 40vmin"],
			image: "/images/logo.png",
			type: "page",
			name: "Test",
			data: "terminal", //identifier of application or page to request from server
		},{
			pos: ["calc(50% - 15vmin)","calc(50% - 20vmin"],
			image: "youtube.png",
			type: "link",
			name: "Blender",
			data: "url", //url for links (external)
		}
	]
	}


let users = [
	{
		id: "id",
		password: "password",
		username: "username",
		handle: "0000", //4 digit number like discord
		nickname: "nickname",
		settings: {
			some: "settings"
		},
		email: "email@example.com",
		verified: true,
		registered_since: 0,
	},
	{
		id: "test",
		password: "test",
		username: "test_user",
		handle: "0909",
		nickname: "for testing",
		settings: {
			
		},
		email: "test@example.com",
		verified: true,
		registered_since: 0,
	}
]


app.get('/', (req, res) => {
  res.sendFile(__dirname + '/index.html');
});

io.on('connection', (socket) => {
	setTimeout(() => {
		socket.emit("desktop_symbols", desktopSymbols);
	}, 100);
	
  socket.on('chat message', (msg) => {
    io.emit('chat message', msg);
  });
  
  // Setinterval 1s heartbeat, serves as driver for client clock
  // used to detect lost connection clientside
  
  
  function heartbeat () {
	  socket.emit("heartbeat", "");
  }
  let hb = setInterval(heartbeat, 1000);
  socket.on("disconnect", ()=>{clearInterval(hb)});
  
  
  
  // socket.emit("add_dynscript", {js: "alert('test')"})
  socket.on('login', (msg) => {
	
	  let t = users.filter((u) => u.username == msg.username)
		  
	  if (t.length == 0) {
		  socket.emit("wrong_pw", "");
		  return;
	  }
	 if (msg.password == t[0].password) {
		 
		  socket.emit("init", {
			  username: t[0].username,
			  handle: t[0].handle,
			  nickname: t[0].nickname,
			  notes: grabNotes(t[0].id),
			  friends: friends[t[0].id],
			  id: t[0].id,
			  profilePicture: "default.jpg"
		  })
		  setTimeout(function () {
			  
			socket.emit("notification", {
				title: "Login successful",
				image: "default.jpg",
				description: "You successfully logged in. Congratulations on being capable of doing basic tasks, proud of ya, bozo",
				clickEvent: {}
			})
		  }, 200);
	  } else {
		  socket.emit("wrong_pw", "");
	  }
  });
  
  socket.on('delete_note', (msg) => {
	  deleteNote(msg.user, msg.index); //user is token
  })
  socket.on("add_note", (msg) => {
	  // ALL USER RELATED STUFF NEEDS TO USE THE ACCORDING SESSION TOKEN!!!
	  addNote(msg.user, msg.note);
  })
  socket.on("request_page", (msg) => {
	serveSubpage(msg, socket);
  });
  socket.on("request_settings", (msg) => {
	serveSettings(msg, socket);
  });
  socket.on("terminal_req", (msg) => {
	let response = terminal(msg);
	socket.emit("terminal_res", response)
  });
  socket.on("logout", (msg) => {
	  socket.emit("logout_confirm","")
	  socket.emit("notification", {
				title: "Logout successful",
				image: "default.jpg",
				description: "Well fuck off then, i dont care.",
				clickEvent: {}
			})
  })
  socket.on("req_subsettings", (msg) => {
	 reqSettingsSub(socket, msg); 
  });
});

function terminal({cmd, fp, id}) {
	return {
		res: "command executed",
		fp: "~home\\folder",
		id: id
	}
}

function reqSettingsSub(socket, msg) {
	const html = fs.readFileSync(`./html/settings/${msg.query.split("_")[1]}.html`).toString();
	socket.emit("sub_settings", {html: html, id: msg.id});
}

function serveSettings(msg, socket) {
	const sub = msg.page || "settings_appearance"
	const html = fs.readFileSync(`./html/settings/${sub.split("_")[1]}.html`).toString();
	const js = undefined;// `alert("ooo");`
	socket.emit("add_window", {title: "Settings", "html":fs.readFileSync("./settings.html").toString(), icon: "settings.png", windowClass: "settingswindow", selected: sub, subhtml: html, js: js});
	let reqS = msg.requested || "appearance";
	
}

function deleteNote(user, index) {
	if (!notes[user] || notes[user].length == 0) return;
	let newNoteList = [];
	for (let i = 0; i &lt; notes[user].length; i++) {
		if (i != index) {
			newNoteList.push(notes[user][i]);
		}
	}
	
	notes[user] = newNoteList;
	
}

function addNote(user, note) {
	
	notes[user] = notes[user] || [];
	
	
	notes[user].push(note);
}

function grabUsername(token) {
return users[token].username
}

function grabNotes(username) {
	return notes[username]
}


function serveSubpage({requested}, socket) {
	console.log(requested)
	switch(requested) {
		case "terminal":
			let js = `
			function terminalMain() {
				let terminalinput = document.getElementById("terminal-input");
				let terminallabel = document.getElementById("terminal-label");
				let terminalcontent = document.getElementById("terminal-past");
				terminallabel.dataset.path = "~home"; //This is the filepath
				terminalinput.dataset.rand = Math.round(Math.random() * 100000000);
				console.log(terminalinput.dataset.rand)
				terminalinput.id = terminalinput.id + terminalinput.dataset.rand;
				terminallabel.id = terminallabel.id + terminalinput.dataset.rand;
				terminallabel.textContent = terminallabel.dataset.path + ">"
				terminalcontent.id = terminalcontent.id + terminalinput.dataset.rand;
				socket.on("terminal_res", ({res, fp, id}) => {
					console.log(id, terminalinput.dataset.rand)
					if (id != terminalinput.dataset.rand) return;
					terminallabel.dataset.path = fp;
					let entry = document.createElement("p");
					entry.style = "line-height: 14px; margin: 0;";
					entry.textContent = res;
					terminalcontent.appendChild(entry);
					terminallabel.textContent = terminallabel.dataset.path + ">";
				})
				let terminalWindowBody = terminalinput.parentNode.parentNode;
				terminalWindowBody.addEventListener("click", (event) => {
					terminalinput.focus();
				}) 
				terminalinput.addEventListener("keydown", (event) => {
					if (event.key == "Enter") {
						event.preventDefault();
						socket.emit("terminal_req", {cmd: terminalinput.textContent, fp: terminallabel.dataset.path, id: terminalinput.dataset.rand})
						let entry = document.createElement("p");
						entry.style = "line-height: 14px; margin: 0;"
						entry.textContent = terminallabel.textContent + " " + terminalinput.textContent;
						terminalinput.textContent = "";
						terminalcontent.appendChild(entry)
					}
				})
			}
			terminalMain();

			`
			socket.emit("add_window", {title: "Terminal", "html":fs.readFileSync("./terminal.html").toString(), icon: "settings.png", js: js, width: "800px", height: "480px"});
			break;
	}
}

function serveTerminal(msg, socket) {
	
}

server.listen(3000, () => {
  console.log('listening on *:3000');
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Auth.html">Auth</a></li><li><a href="module-Clock.html">Clock</a></li><li><a href="module-DesktopSymbol.html">DesktopSymbol</a></li><li><a href="module-Dragging.html">Dragging</a></li><li><a href="module-ErrorMessage.html">ErrorMessage</a></li><li><a href="module-Login.html">Login</a></li><li><a href="module-Startmenu.html">Startmenu</a></li><li><a href="module-Utilities.html">Utilities</a></li><li><a href="module-Widget.html">Widget</a></li><li><a href="module-Windows.html">Windows</a></li></ul><h3>Namespaces</h3><ul><li><a href="Main.html">Main</a></li><li><a href="module-ErrorMessage-Buttons.html">Buttons</a></li><li><a href="module-Utilities-Shorthands.html">Shorthands</a></li></ul><h3>Classes</h3><ul><li><a href="module-Windows.Window.html">Window</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Number%25E2%2580%25A4prototype%25E2%2580%25A4range">Number․prototype․range</a></li><li><a href="global.html#Number%25E2%2580%25A4prototype%25E2%2580%25A4to">Number․prototype․to</a></li><li><a href="global.html#terminalKeyDownEvent">terminalKeyDownEvent</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Sat Apr 15 2023 20:34:20 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
